<html>
<head>
    <link type="text/css" href="styles.css" rel="stylesheet" />

<link rel="stylesheet" type="text/css"
          href="https://fonts.googleapis.com/css?family=Raleway">
<style type="text/css">
	body {
        font-family: 'Raleway';
        font-size: 20px;
      }
</style>
<title>Junior Music Algorithm Testing</title>
<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
</head>
<body>
<div id='main' class="top worker jumbotron jumbotron-hero container-fluid">
      <div id="jumbo-dialog">
        <h1 id='ttitle'>Help Train Junior Music</h1>
        <p class='ttext'>
            Thanks for helping us test out Junior Music. We'll need to access your Spotify
            history in order to do this test. We will not use your data for anything
            malicious, embarassing, defaming, or evil.
        </p>
        <p class='ttext'>Something about the project, procedure, etc. can go here.</p>
        <p class='ttext'>Click the 'Login with Spotify' button below to go to the account authorization page.</p>
        <div class="wrapper">
        <p><a class="btn btn-primary btn-lg" id='go' role="button" onclick="authorizeUser()">Login with Spotify</a></p>
        <!-- <button class="button">Login with Spotify</button> -->

        <p id="successtext">
        </p>

        </div>
      </div>
  </div>
<div class="container" id="loginSuccess">
<p>Hello, world!</p>

</div>
<!-- <script src="lib/bootstrap.min.js"></script> -->
<script src="lib/underscore-min.js"></script>
<script src="config.js"></script>
<script type="text/javascript" charset="utf-8" src="//cdnjs.cloudflare.com/ajax/libs/q.js/1.4.1/q.min.js"></script>

<script type="text/javascript">

var accessToken = null;
var curUserID = null;

	
function authorizeUser() {
    var scopes = 'user-top-read';
    var url = 'https://accounts.spotify.com/authorize?client_id=' + SPOTIFY_CLIENT_ID +
        '&response_type=token' +
        '&scope=' + encodeURIComponent(scopes) +
        '&redirect_uri=' + encodeURIComponent(SPOTIFY_REDIRECT_URI);
    document.location = url;
}

function parseArgs() {
    console.log('I am parsing args. I am a pirate.')
    var hash = location.hash.replace(/#/g, '');
    var all = hash.split('&');
    var args = {};
    _.each(all, function(keyvalue) {
        var kv = keyvalue.split('=');
        var key = kv[0];
        var val = kv[1];
        args[key] = val;
    });
    return args;
}

function getSpotify(url, data) {
    $.ajax(url, {
        dataType: 'json',
        data: data,
        headers: {
            'Authorization': 'Bearer ' + accessToken
        },
        success: function(r) {
          console.log('GET success');
          console.log(r);
          return r;
        },
        error: function(r) {
          console.log('GET fail')
          return r;
        }
    });

}

function fetchCurrentUserProfile() {
    var url = 'https://api.spotify.com/v1/me';
    getSpotify(url, null);
}

function getTopTracks(uid) {
  // https://api.spotify.com/v1/me/top/{type}
  var url = 'https://api.spotify.com/v1/me/top/tracks'
  var data = {
    limit:50,
    offset:0,
    time_range:'medium_term'
  }

  results = getSpotify(url, data);

  return results;
}

function getTopArtists(uid) {
  // https://api.spotify.com/v1/me/top/{type}
  var url = 'https://api.spotify.com/v1/me/top/artists'
  var data = {
    limit:50,
    offset:0,
    time_range:'medium_term'
  }

  results = getSpotify(url, data);

  return results;
}



$(document).ready(
    function() {
      var args = parseArgs();
      if ('access_token' in args){
        console.log('ARGGGGGGGs!')
        accessToken = args['access_token']
        $(".wrapper").hide();
        $(".ttext").hide();
        $("#successtext").text('Thanks for authorizing the app! We are going to pull some information about your favorite songs and artists. Once that is done, we will show your top five most played songs and artists below.');

        fetchCurrentUserProfile(function(user) {
                if (user) {
                    curUserID = user.id;
                    // $("#who").text(user.id);
                    // loadPlaylists(user.id);
                } else {
                    error("Trouble getting the user profile");
                }
            });
        topTracks = getTopTracks(curUserID);
        topArtists = getTopArtists(curUserID);
        console.log('Tracks Results:')
        console.log(topTracks);
        console.log('Artists Results:')
        console.log(topArtists);
        // run the spotify pull functions!
      } else {
        // $(".successtext").hide();
        console.log('no pirates were found.')
      }
      console.log(args);
      console.log('hello');
    }


  )


</script>
</body>
</html>























